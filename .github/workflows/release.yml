name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          xcodegen generate
          plutil -insert NSExtension \
            -json '{"NSExtensionPointIdentifier":"com.apple.widgetkit-extension"}' \
            ClaudeUsageWidget/Info.plist 2>/dev/null || true

      - name: Build
        run: |
          xcodebuild \
            -project ClaudeUsageWidget.xcodeproj \
            -scheme ClaudeUsageApp \
            -configuration Release \
            -derivedDataPath build \
            build

      - name: Create DMG
        run: |
          mkdir -p dmg-staging
          cp -R "build/Build/Products/Release/TokenEater.app" dmg-staging/
          ln -s /Applications dmg-staging/Applications
          hdiutil create -volname "TokenEater" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            TokenEater.dmg

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Compute SHA256
        id: sha
        run: echo "sha256=$(shasum -a 256 TokenEater.dmg | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Upload to GitHub Release
        run: |
          if gh release view "$GITHUB_REF_NAME" &>/dev/null; then
            gh release upload "$GITHUB_REF_NAME" TokenEater.dmg --clobber
          else
            gh release create "$GITHUB_REF_NAME" TokenEater.dmg \
              --title "TokenEater ${{ steps.version.outputs.version }}" \
              --generate-notes
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify release asset is downloadable
        run: |
          ASSET_URL="https://github.com/AThevon/TokenEater/releases/download/${GITHUB_REF_NAME}/TokenEater.dmg"
          echo "Verifying asset at: ${ASSET_URL}"
          HTTP_STATUS=$(curl -sL -o /dev/null -w '%{http_code}' "$ASSET_URL")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::Release asset not downloadable (HTTP ${HTTP_STATUS}). Aborting Homebrew update."
            exit 1
          fi
          echo "Asset verified (HTTP ${HTTP_STATUS})"

      - name: Update Homebrew Cask
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          NEW_VERSION: ${{ steps.version.outputs.version }}
          NEW_SHA: ${{ steps.sha.outputs.sha256 }}
        run: |
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/AThevon/homebrew-tokeneater.git" /tmp/tap
          cd /tmp/tap

          sed -i '' "s/version \".*\"/version \"${NEW_VERSION}\"/" Casks/tokeneater.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${NEW_SHA}\"/" Casks/tokeneater.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/tokeneater.rb
          git commit -m "bump: tokeneater ${NEW_VERSION}"
          git push
