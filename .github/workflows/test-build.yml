name: Test Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build"
        required: true
        default: "main"

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Print toolchain info
        run: |
          xcodebuild -version
          swift --version
          sw_vers

      - name: Generate Xcode project
        run: |
          xcodegen generate
          plutil -insert NSExtension \
            -json '{"NSExtensionPointIdentifier":"com.apple.widgetkit-extension"}' \
            TokenEaterWidget/Info.plist 2>/dev/null || true

      - name: Build
        run: |
          xcodebuild \
            -project TokenEater.xcodeproj \
            -scheme TokenEaterApp \
            -configuration Release \
            -derivedDataPath build \
            build

      - name: Create DMG
        run: |
          mkdir -p dmg-staging
          cp -R "build/Build/Products/Release/TokenEater.app" dmg-staging/
          ln -s /Applications dmg-staging/Applications
          hdiutil create -volname "TokenEater" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            TokenEater.dmg

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: TokenEater-test
          path: TokenEater.dmg
